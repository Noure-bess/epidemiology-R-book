---
title: "Temporal analysis: Model fitting 2"
description: |
  Fitting of the population dynamic models to replicated disease progress curve data (designed experiments)
author:
  - name: Emerson M. Del Ponte
    url: https://emersondelponte.netlify.app
    affiliation: Universidade Federal de Vi√ßosa
    affiliation_url: https://www.ufv.br/dfp
date: "`r Sys.Date()`"
site: distill::distill_website
bibliography: references.bib
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
---

In this next exercise, we will work with disease data collected over time in the same plot unit (also called repeated measures) from a designed experiment for evaluating and comparing treatment effects.

Again, we will use a dataset of progress curves shown in page 98 [@chapter2017f]. The curves represent the incidence of soybean plants symptomatic for bud blight caused by tobacco streak virus. Four treatments (different planting dates) were evaluated in randomized complete block design with four replicates. There are four assessment in time for each curve. The data was stored as a csv file and will be loaded using `read_csv()` function and stored as dataframe called `budblight`.

#### Loading data

```{r, echo = TRUE}
library(tidyverse)
budblight <- read_csv("data/bud-blight-soybean.csv")
```

Let's have a look at the first six rows of the dataset and check the data type for each column. There is an additional column representing the replicates, called block.

```{r, echo = TRUE}
head(budblight)
```

#### Visualizing the DPCs

Let's have a look at the curves and produce a combo plot figure similar to Fig. 4.17 of the book, but without the line of the predicted values.

```{r echo=TRUE}
p3 <- budblight %>%
  ggplot(aes(
    time, y,
    group = block,
    shape = factor(block)
  )) +
  geom_point(size = 1.5) +
  ylim(0, 0.6) +
  theme(legend.position = "none") +
  facet_wrap(~treat, ncol = 1) +
  labs(
    y = "Disease incidence",
    x = "Time (days after emergence)"
  )
```

```{r echo=TRUE}
p4 <- budblight %>%
  ggplot(aes(
    time, log(1 / (1 - y)),
    group = block,
    shape = factor(block)
  )) +
  geom_point(size = 2) +
  facet_wrap(~treat, ncol = 1) +
  theme(legend.position = "none") +
  labs(y = "Transformed incidence", x = "Time (days after emergence)")

library(patchwork)
p3 | p4
```

#### Model fitting

Remember that the first step in model selection is the visual appraisal of the curve data linearized with the model transformation. In the case the curves represent complete epidemics (close to 100%) appraisal of the absolute rate (difference in y between two times) over time is also helpful.

For the treatments above, it looks like the curves are typical of a monocyclic disease (the case of soybean bud blight), for which the monomolecular is usually a good fit, but other models are also possible as well. For this exercise, we will use both the linear and the nonlinear estimation method.

##### Linear regression

For convenience, we use the `fit_multi()` to handle multiple epidemics. The function returns a list object where a series of statistics are provided to aid in model selection and parameter estimation. We need to provide the names of columns (arguments): assessment time (`time_col`), disease incidence (`intensity_col`), and treatment (`strata_cols`).

```{r, echo = TRUE}
library(epifitter)
lin1 <- fit_multi(
  time_col = "time",
  intensity_col = "y",
  data = budblight,
  strata_cols = "treat",
  nlin = FALSE
)
```

Let's look at how well the four models fitted the data. Epifitter suggests the best fitted model (1 to 4, where 1 is best) for each treatment. Let's have a look at the statistics of model fitting.

```{r, echo = TRUE}

lin1$Parameters %>%
  select(treat, best_model, model, CCC, RSE)
```

And now we extract values for each parameter estimated from the fit of the monomolecular model.

```{r, echo = TRUE}

lin1$Parameters %>%
  filter(model == "Monomolecular") %>%
  select(treat, y0, r)
```

Now we visualize the fit of the monomolecular model (using `filter` function - see below) to the data together with the observed data and then reproduce the right plots in Fig. 4.17 from the book.

```{r, echo = TRUE}

lin1$Data %>%
  filter(model == "Monomolecular") %>%
  ggplot(aes(time, predicted)) +
  geom_point(aes(time, y)) +
  geom_line(size = 0.5) +
  facet_wrap(~treat) +
  coord_cartesian(ylim = c(0, 0.6)) + # set the max to 0.6
  labs(
    y = "Disease incidence",
    x = "Time (days after emergence)"
  )
```

Now we can plot the means and respective 95% confidence interval of the apparent infection rate ($r$) and initial inoculum ($y_0$) for visual inference.

```{r, echo = TRUE}

p5 <- lin1$Parameters %>%
  filter(model == "Monomolecular") %>%
  ggplot(aes(treat, r)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = r_ci_lwr, ymax = r_ci_upr),
    width = 0,
    size = 1
  ) +
  labs(
    x = "Time",
    y = "r"
  )

p6 <- lin1$Parameters %>%
  filter(model == "Monomolecular") %>%
  ggplot(aes(treat, 1 - exp(-y0))) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = y0_ci_lwr, ymax = y0_ci_upr),
    width = 0,
    size = 1
  ) +
  labs(
    x = "Time",
    y = "y0"
  )

p5
```

##### Non-linear regression

To estimate the parameters using the non-linear approach, we repeat the same arguments in the `fit_multi` function, but include an additional argument `nlin` set to `TRUE`.

```{r, echo = TRUE}
nlin1 <- fit_multi(
  time_col = "time",
  intensity_col = "y",
  data = budblight,
  strata_cols = "treat",
  nlin = TRUE
)
```

Let's check statistics of model fit.

```{r, echo = TRUE}
nlin1$Parameters %>%
  select(treat, model, CCC, RSE, best_model)
```

And now we obtain the two parameters of interest. Note that the values are not the sames as those estimated using linear regression, but they are similar and highly correlated.

```{r, echo = TRUE}

nlin1$Parameters %>%
  filter(model == "Monomolecular") %>%
  select(treat, y0, r)
```

```{r, echo = TRUE}

p7 <- nlin1$Parameters %>%
  filter(model == "Monomolecular") %>%
  ggplot(aes(treat, r)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = r_ci_lwr, ymax = r_ci_upr),
    width = 0,
    size = 1
  ) +
  labs(
    x = "Time",
    y = "r"
  )

p8 <- nlin1$Parameters %>%
  filter(model == "Monomolecular") %>%
  ggplot(aes(treat, y0)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = y0_ci_lwr, ymax = y0_ci_upr),
    width = 0,
    size = 1
  ) +
  labs(
    x = "Time",
    y = "y0"
  )

p7 | p8
```
